# tasks/init-control-plane.yml
---

- name: Copy initial kubeadm template
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ k8s_cluster_kubelet_config_root_dir }}/{{ item }}"
    owner: root
    group: root
    mode: 0640
  loop: ["kubeadm-init-config.yml"]

- name: Pre pull required images
  ansible.builtin.shell: |
    kubeadm config images pull
  changed_when: False

- name: Run kubeadm init
  ansible.builtin.shell: |
    kubeadm init \
      --config={{ k8s_cluster_kubelet_config_root_dir }}/kubeadm-init-config.yml \
        > /tmp/kubeadm.log 2>&1
  register: command_result
  failed_when: command_result.rc != 0
  ignore_errors: true
  changed_when: False

- name: Query logs
  ansible.builtin.shell: |
    cat /tmp/kubeadm.log
  args:
    executable: /bin/bash
  register: cat_show
  changed_when: False

- name: Show kubeadm logs
  ansible.builtin.debug:
    var: cat_show

# https://github.com/flannel-io/flannel
- name: Configure Flannel networking
  ansible.builtin.shell: |
    kubectl apply \
      -f {{ k8s_cluster_flannel_apply }} \
      --kubeconfig=/etc/kubernetes/admin.conf \
        > /tmp/flannel.log 2>&1
  changed_when: False
