---

k8s_cluster_kubelet_version: '1.26.0-00'
k8s_cluster_kubeadm_version: '1.26.0-00'
k8s_cluster_kubectl_version: '1.26.0-00'

k8s_cluster_apt_key_url: 'https://packages.cloud.google.com/apt/doc/apt-key.gpg'
k8s_cluster_apt_repository: 'deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main'

k8s_cluster_kubernetes_version: 1.26.0
k8s_cluster_kubelet_config_root_dir: '/etc/kubernetes'
k8s_cluster_ignore_preflight_errors: "all"

k8s_cluster_node_type: worker
k8s_cluster_initial_master: false

# https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/#kubeadm-k8s-io-v1beta3-InitConfiguration
k8s_cluster_init_configuration:
  # localAPIEndpoint represents the endpoint of the API server instance that's deployed on this
  # control plane node. In HA setups, this differs from ClusterConfiguration.controlPlaneEndpoint
  # in the sense that controlPlaneEndpoint is the global endpoint for the cluster, which then
  # load-balances the requests to each individual API server. This configuration object lets you
  # customize what IP/DNS name and port the local API server advertises it's accessible on.
  # By default, kubeadm tries to auto-detect the IP of the default interface and use that, but in
  # case that process fails you may set the desired value here.
  localAPIEndpoint:
    advertiseAddress: "{{ hostvars[inventory_hostname]['ansible_facts']['default_ipv4']['address'] }}"
    bindPort: 6443  # default 6443

# https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/#kubeadm-k8s-io-v1beta3-ClusterConfiguration
k8s_cluster_cluster_configuration:
  networking:
    podSubnet: "{{ k8s_cluster_pod_network.cidr }}"
  kubernetesVersion: "{{ k8s_cluster_kubernetes_version }}"
  controlPlaneEndpoint: "{{ hostvars[inventory_hostname]['ansible_facts']['default_ipv4']['address'] }}"

# https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/
k8s_cluster_kubelet_configuration:
  cgroupDriver: systemd
  failSwapOn: false

# https://kubernetes.io/docs/reference/config-api/kube-proxy-config.v1alpha1/
k8s_cluster_kubeproxy_configuration: ""

# https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/#kubeadm-k8s-io-v1beta3-JoinConfiguration
#
# configuration below is optimized to join worker nodes
# for master nodes it could be required to add JoinConfiguration.JoinControlPlane field
k8s_cluster_join_configuration:
  # holds fields that relate to registering the new node to the cluster; use it to customize
  # the node name, the CRI socket to use or any other settings that should apply to this
  # node only (e.g. the node ip)
  nodeRegistration:
    ignorePreflightErrors:
      - SystemVerification
      - FileAvailable
      - DirAvailable
      - Port
  # options for the kubelet to use during the TLS bootstrap process
  discovery:
    bootstrapToken:
      token: "{{ k8s_cluster_join_token }}"
      apiServerEndpoint: "{{ k8s_cluster_api_server_ip }}:{{ k8s_cluster_init_configuration.localAPIEndpoint.bindPort }}"
      # caCertHashes specifies a set of public key pins to verify when token-based discovery
      # is used. The root CA found during discovery must match one of these values. Specifying
      # an empty set disables root CA pinning, which can be unsafe. Each hash is specified
      # as <type>:<value>, where the only currently supported type is "sha256". This is a hex-encoded
      # SHA-256 hash of the Subject Public Key Info (SPKI) object in DER-encoded ASN.1.
      #
      # it could be obtained using the following command chain on the control-plane node:
      #   openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \
      #   openssl dgst -sha256 -hex | sed 's/^.* //'
      #
      # otherwise use "unsafeSkipCAVerification: true" but this can weaken the security of kubeadm
      # since other nodes can impersonate the control-plane
      caCertHashes:
        - "sha256:{{ k8s_cluster_root_ca_hash }}"
      unsafeSkipCAVerification: false
  controlPlane:
    localAPIEndpoint:
      advertiseAddress: "{{ k8s_cluster_local_api }}"
      bindPort: 6443

k8s_cluster_pod_network:
  # Flannel CNI.
  cni: 'flannel'
  cidr: '10.244.0.0/16'

# https://github.com/flannel-io/flannel
k8s_cluster_flannel_apply: https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
